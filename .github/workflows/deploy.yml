name: version-tagging

on:
  pull_request:
    branches: [main]
    types: [closed] # PR 머지될 때만 작동

jobs:
  bump-version-and-tag:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get current version tag
        id: get_latest
        run: |
          git fetch --tags
          TAG=$(git tag --sort=-v:refname | head -n 1)
          echo "LATEST_TAG=$TAG" >> $GITHUB_ENV

      - name: Extract version components
        id: split
        run: |
          VERSION=${{ env.LATEST_TAG }}
          VERSION="${VERSION#v}" # remove 'v'
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          LABELS="${{ toJson(github.event.pull_request.labels) }}"
          if [[ "$LABELS" == *"major"* ]]; then
            MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0
          elif [[ "$LABELS" == *"minor"* ]]; then
            MINOR=$((MINOR + 1)); PATCH=0
          elif [[ "$LABELS" == *"patch"* ]]; then
            PATCH=$((PATCH + 1))
          else
            echo "❌ No version label found"; exit 1
          fi

          NEW_TAG="v$MAJOR.$MINOR.$PATCH"
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Create new tag and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git tag ${{ env.NEW_TAG }}
          git push origin ${{ env.NEW_TAG }}

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # 자동 제공되는 기본 토큰
        with:
          tag_name: ${{ env.NEW_TAG }}
          release_name: Release ${{ env.NEW_TAG }}
          body: |
            🔖 PR: #${{ github.event.pull_request.number }}
            🔧 Author: @${{ github.event.pull_request.user.login }}
            📝 변경사항: ${{ github.event.pull_request.title }}
          draft: false
          prerelease: false
