name: ë²„ì „ íƒœê¹… ìë™í™”

on:
  pull_request:
    branches: [main]
    types: [closed] # PRì´ ë¨¸ì§€ë  ë•Œë§Œ ì‘ë™

jobs:
  bump-version-and-release:
    if: github.event.pull_request.merged == true
    name: ë²„ì „ ì—…ë°ì´íŠ¸ ë° ë¦´ë¦¬ìŠ¤ ìƒì„±
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.split_and_bump.outputs.new_tag }}
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ìµœì‹  ë²„ì „ íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
        id: get_latest
        run: |
          git fetch --tags
          TAG=$(git tag --sort=-v:refname | head -n 1)
          echo "LATEST_TAG=$TAG" >> $GITHUB_ENV

      - name: ë²„ì „ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
        id: split_and_bump
        run: |
          VERSION=${{ env.LATEST_TAG }}
          VERSION="${VERSION#v}" # 'v' ì œê±°
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          LABELS_JSON='${{ toJson(github.event.pull_request.labels) }}'
          LABEL_NAMES=$(echo "$LABELS_JSON" | jq -r '.[].name')

          VERSION_TYPE=""
          for label in $LABEL_NAMES; do
            if [[ "$label" == "major" ]]; then
              VERSION_TYPE="major"
            elif [[ "$label" == "minor" ]]; then
              VERSION_TYPE="minor"
            elif [[ "$label" == "patch" ]]; then
              VERSION_TYPE="patch"
            fi
          done

          if [[ -z "$VERSION_TYPE" ]]; then
            echo "âŒ ìœ íš¨í•œ ë²„ì „ ë¼ë²¨ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          case $VERSION_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_TAG="v$MAJOR.$MINOR.$PATCH"
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Git íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git tag ${{ env.NEW_TAG }}
          git push origin ${{ env.NEW_TAG }}

      - name: GitHub ë¦´ë¦¬ìŠ¤ ìƒì„±
        uses: softprops/action-gh-release@v2.2.2
        with:
          tag_name: ${{ env.NEW_TAG }}
          name: ë¦´ë¦¬ìŠ¤ ${{ env.NEW_TAG }}
          body: |
            ğŸ”– PR ë²ˆí˜¸: #${{ github.event.pull_request.number }}
            ğŸ”§ ì‘ì„±ì: @${{ github.event.pull_request.user.login }}
            ğŸ“ ë³€ê²½ì‚¬í•­: ${{ github.event.pull_request.title }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-image-and-push:
    name: ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œì™€ í‘¸ì‹œ
    needs: bump-version-and-release
    runs-on: ubuntu-latest
    env:
      DOCKER_IMAGE_NAME: app20250317
    outputs:
      DOCKER_IMAGE_NAME: ${{ env.DOCKER_IMAGE_NAME }}
      OWNER_LC: ${{ env.OWNER_LC }}
    steps:
      - uses: actions/checkout@v4

      - name: .env íŒŒì¼ ìƒì„±
        env:
          ENV_FILE_CONTENT: ${{ secrets.ENV_FILE }}
        run: echo "$ENV_FILE_CONTENT" > .env

      - name: Docker Buildx ì„¤ì¹˜
        uses: docker/setup-buildx-action@v3

      - name: ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: set lower case owner name
        run: echo "OWNER_LC=${OWNER,,}" >> $GITHUB_ENV
        env:
          OWNER: "${{ github.repository_owner }}"

      - name: ë¹Œë“œ ì•¤ í‘¸ì‹œ
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          cache-from: type=registry,ref=ghcr.io/${{ env.OWNER_LC }}/${{ env.DOCKER_IMAGE_NAME }}:cache
          cache-to: type=registry,ref=ghcr.io/${{ env.OWNER_LC }}/${{ env.DOCKER_IMAGE_NAME }}:cache,mode=max
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/${{ env.DOCKER_IMAGE_NAME }}:${{ needs.bump-version-and-release.outputs.tag_name }}
            ghcr.io/${{ env.OWNER_LC }}/${{ env.DOCKER_IMAGE_NAME }}:latest

  deploy:
    name: ë°°í¬
    runs-on: ubuntu-latest
    needs: build-image-and-push
    permissions:
      id-token: write
      contents: read
    env:
      DOCKER_IMAGE_NAME: ${{ needs.build-image-and-push.outputs.DOCKER_IMAGE_NAME }}
      OWNER_LC: ${{ needs.build-image-and-push.outputs.OWNER_LC }}

    steps:
      - name: AWS ë¡œê·¸ì¸ (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/dev-github-actions-role
          aws-region: ap-northeast-2

      - name: ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ ID ê°€ì ¸ì˜¤ê¸°
        id: get_instance_ids
        run: |
          INSTANCE_IDS=$(aws ec2 describe-instances \
            --filters "Name=tag:Role,Values=app-server" "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].InstanceId" --output text)
          echo "INSTANCE_IDS=$INSTANCE_IDS" >> $GITHUB_ENV

      - name: ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ì— ë°°í¬ ëª…ë ¹ ì‹¤í–‰
        run: |
          for ID in $INSTANCE_IDS; do
            aws ssm send-command \
              --instance-ids "$ID" \
              --document-name "AWS-RunShellScript" \
              --parameters "$(cat <<EOF
              {
                "commands": [
                  "docker pull ghcr.io/${{ env.OWNER_LC }}/${{ env.DOCKER_IMAGE_NAME }}:latest",
                  "docker stop app1 || true",
                  "docker rm app1 || true",
                  "docker run -d --network common --name app1 -p 8080:8080 ghcr.io/${{ env.OWNER_LC }}/${{ env.DOCKER_IMAGE_NAME }}:latest",
                  "docker rmi \$(docker images -f 'dangling=true' -q)"
                ]
              }
              EOF
              )" \
              --comment "Deploy app" \
              --region ap-northeast-2
              done
